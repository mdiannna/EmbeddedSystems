#include <Arduino.h>
#include "mystdio.h"
#include "led.h"
#include "analoglibrary.h"
#include "lightsensor.h"
#include "pressure_temp_altitude.h"

//#define R 10000 //ohm resistance value
//#define R 15000 //ohm resistance value
float R = 15000;

#define Vin 5.0 // input voltage
float * buff;
int cnt = 0;
float median = 0;

void setup() {
	SerialInit();
	LightSensorInit();
	LED_Init();
	InitBMPSensor();

	buff = (float*) malloc(3*sizeof(float));

	printf("Initialization done\n");
}


void showLightResults(int lightLevel) {
	printf("-------\n");
	printf("\n";)
	float Vout = ADCtoVoltage(lightLevel);
	float resistance = VoltageToResistance(R, Vin, Vout);

	printf("LIGHT LEVEL: %d\n\r", lightLevel);
	printf("Resistance: %d\n\r", resistance);
	Serial.println(resistance);

	printf("Voltage: %.2f\n\r", Vout);
	Serial.println(Vout);

	float lux = ResistanceToLumen(resistance);
	printf("Light intensity(lumen) - physical parameter: %f\n\r", lux);
	Serial.print(lux);
	printf("-------\n");
}


void loop() {

	int lightLevel = ReadLightLevel();
	printf("Light level: %d\n\r", lightLevel);

	if(cnt==3){
		cnt = 0;
		showLightResults(median);
	}

	buff[cnt] = lightLevel;
	median = SaltAndPepperFilter(buff);
	cnt++;




	//TestSensorBMP();


	delay(500);
	LED_On();
	delay(500);
	LED_Off();
	delay(500);
}
